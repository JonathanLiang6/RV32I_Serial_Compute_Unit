# 基于 RISC-V 指令集的串行计算单元

## 一、概述

本项目是一个基于 RISC-V 指令集的串行计算单元设计，使用 Verilog 硬件描述语言实现。通过多个功能模块协同工作，可执行 RISC-V 指令集中的部分指令，并通过开关控制和数码管显示进行调试与观察。

## 二、功能描述

### 2.1 指令执行

支持 RISC-V 指令集中的多种指令类型，如 R 型（如 add、sub）、I 型（如 addi、lw）、S 型（如 sw）等。能够根据指令进行相应的算术运算、数据存储与加载操作，完成复杂的计算任务。

### 2.2 时钟分频与控制

通过时钟分频逻辑生成不同频率的时钟信号。`sw_i[15]`控制选择`clkdiv[27]`（慢速）或`clkdiv[25]`（快速）作为`Clk_CPU`，`Clk_instr`由`Clk_CPU`和`sw_i[1]`共同控制，确保指令执行在合适的时钟节拍下进行。

### 2.3 数据存储与读取

- **寄存器文件（RF）**：包含 32 个 32 位寄存器，复位时寄存器值为其索引值。在`RFwr`和有效`A3`地址的控制下写入数据，根据`A1`和`A2`地址读取数据，地址为 0 时返回 0。
- **数据存储器（DM）**：具有 128 字节存储空间，可按字节、半字、字的方式存储和读取数据。写操作在`DMWr`有效时，依据`DMType`确定写入方式；读操作同样根据`DMType`进行有符号或无符号扩展读取。

### 2.4 显示功能

- **数码管显示**：通过`seg7x16`模块驱动数码管，根据`sw_i[0]`切换显示模式。模式 0 下，`sw_i[14:11]`选择显示指令存储器（ROM）、寄存器文件（RF）、ALU 数据或数据存储器（DMEM）；模式 1 下显示 LED 数据存储器内容。
- **LED 数据存储器**：存储 19 组 64 位数据，用于特定显示场景，通过`led_data_addr`和`sw_i[0]`控制数据读取与显示。

## 三、模块介绍

### 3.1 顶层模块（sccomp）

整合各功能模块，负责连接各个模块的信号，实现数据和控制信号的传递。根据开关`sw_i`的设置，控制整个计算单元的运行状态和显示内容。

### 3.2 控制模块（ctrl）

对指令的操作码（Op）、Funct7、Funct3 进行译码，结合 ALU 的 Zero 标志，生成寄存器写使能（RegWrite）、数据存储器写使能（MemWrite）、扩展操作类型（EXTOp）、ALU 操作类型（ALUOp）、ALU 源选择（ALUSrc）、数据存储器访问类型（DMType）、写回数据选择（WDSel）以及下一个程序计数器操作类型（NPCOp）等控制信号。

### 3.3 扩展模块（EXT）

根据`EXTOp`信号，对 I 型、S 型、B 型和 J 型指令的立即数进行符号扩展或特定格式扩展，将 12 位或 19 位的立即数扩展为 32 位，为 ALU 运算和地址计算提供合适的操作数。

### 3.4 PC 与 NPC 模块

- **PC 模块**：根据时钟信号、复位信号和`sw_i[1]`控制程序计数器的值。复位时`PCout`清零，`sw_i[1]`为 0 时更新为`NPC`值，达到`32'h00000048`时重置为 0。
- **NPC 模块**：依据`NPCOp`信号计算下一个程序计数器的值。普通情况（`NPC_PLUS4`）下`NPC = PC + 4`；分支指令（`NPC_BRANCH`、`NPC_JAL`）时`NPC = PC + immout`；`NPC_JALR`时`NPC = aluout`。

### 3.5 寄存器文件模块（RF）

在时钟上升沿或复位信号下降沿，根据`RFwr`和有效地址`A3`写入数据`WD`。根据`A1`和`A2`地址读取数据`RD1`和`RD2`，地址为 0 时返回 0。

### 3.6 ALU 模块

根据`ALUOp`信号对输入操作数`A`和`B`进行算术逻辑运算，如加法（`ALUOp_add`）、减法（`ALUOp_sub`）等。运算结果存储在`C`中，并根据结果设置`Zero`标志。

### 3.7 数据存储器模块（DM）

在时钟上升沿或复位信号下降沿，当`DMWr`有效时，根据`DMType`将`din`数据写入指定`addr`的存储单元。读取时，同样依据`DMType`从存储单元中读取数据并进行相应扩展后输出`dout`。

### 3.8 七段数码管显示模块（seg7x16）

对输入的显示数据`i_data`进行处理，根据`disp_mode`和`seg7_addr`选择显示的字节。将显示数据转换为七段数码管的段选信号`o_seg`和位选信号`o_sel`，实现数码管的动态扫描显示。

## 四、使用说明

### 4.1 硬件连接

将开发板的时钟信号连接到`clk`引脚，复位信号连接到`rstn`引脚（低电平有效），开关信号连接到`sw_i`引脚，数码管段选和位选引脚分别连接到`disp_seg_o`和`disp_an_o`引脚。

### 4.2 开关控制功能

- `sw_i[15]`：控制 CPU 时钟频率，为 1 选择慢速时钟（`clkdiv[27]`），为 0 选择快速时钟（`clkdiv[25]`）。
- `sw_i[14:11]`：在`sw_i[0]`为 0 时，选择显示内容，`4'b1000`显示 ROM 数据，`4'b0100`显示 RF 数据，`4'b0010`显示 ALU 数据，`4'b0001`显示 DMEM 数据。
- `sw_i[13]`：控制寄存器地址递增显示，为 1 时递增显示寄存器内容。
- `sw_i[11]`：控制数据存储器地址递增显示，为 1 时递增显示数据存储器内容。
- `sw_i[0]`：控制显示模式，为 0 选择显示 ROM、RF、ALU 或 DMEM 数据，为 1 显示 LED 数据存储器内容。

### 4.3 运行与调试

1. 复位系统，确保各模块初始化到初始状态，寄存器文件和数据存储器清零。
2. 根据需求设置开关`sw_i`的值，选择时钟频率、显示内容和显示模式。
3. 观察数码管显示，结合开关设置分析各模块的工作状态和数据变化。若需深入调试，可使用硬件开发工具的调试功能，查看信号波形和内部寄存器值。

## 五、注意事项

1. 确保复位信号有效时间足够长，保证各模块正确初始化。
2. 开关设置应按照功能说明进行，避免错误设置导致系统异常。
3. 由于数码管动态扫描显示原理，快速切换显示内容时可能出现视觉暂留现象，不影响系统实际运行结果。
4. 本设计仅实现了 RISC-V 指令集的部分功能，复杂指令或特殊情况可能未完全覆盖，使用时需注意指令兼容性。